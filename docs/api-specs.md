# API仕様書

## 1. API概要

### 1.1 基本情報
- **ベースURL**: `/api`
- **プロトコル**: HTTP/HTTPS
- **データ形式**: JSON
- **文字エンコーディング**: UTF-8
- **フレームワーク**: Next.js App Router API Routes

### 1.2 共通仕様
- **Content-Type**: `application/json`
- **レスポンス形式**: JSON
- **エラーレスポンス**: `{ "error": "エラーメッセージ" }`
- **成功レスポンス**: データオブジェクトまたは配列

### 1.3 ステータスコード
- `200`: OK（成功）
- `201`: Created（作成成功）
- `400`: Bad Request（リクエスト不正）
- `404`: Not Found（リソースが見つからない）
- `500`: Internal Server Error（サーバーエラー）

## 2. スレッド関連API

### 2.1 スレッド一覧取得

#### 基本情報
- **エンドポイント**: `GET /api/threads`
- **説明**: 全スレッドを更新日時降順で取得

#### リクエスト
```http
GET /api/threads
```

#### レスポンス
**成功時（200）:**
```json
[
  {
    "_id": "507f1f77bcf86cd799439011",
    "title": "スレッドタイトル",
    "description": "スレッドの説明",
    "category": "一般",
    "creator": "作成者名",
    "postCount": 5,
    "createdAt": "2024-01-01T00:00:00.000Z",
    "updatedAt": "2024-01-01T12:00:00.000Z"
  }
]
```

**エラー時（500）:**
```json
{
  "error": "スレッドの取得に失敗しました"
}
```

### 2.2 スレッド作成

#### 基本情報
- **エンドポイント**: `POST /api/threads`
- **説明**: 新しいスレッドを作成

#### リクエスト
```http
POST /api/threads
Content-Type: application/json

{
  "title": "新しいスレッド",
  "description": "スレッドの説明",
  "category": "一般",
  "creator": "作成者名" // 省略可（デフォルト: "匿名"）
}
```

#### バリデーション
- `title`: 必須、文字列、最大100文字
- `description`: 必須、文字列、最大300文字
- `category`: 必須、文字列、最大50文字
- `creator`: 任意、文字列、最大50文字

#### レスポンス
**成功時（201）:**
```json
{
  "_id": "507f1f77bcf86cd799439011",
  "title": "新しいスレッド",
  "description": "スレッドの説明",
  "category": "一般",
  "creator": "作成者名",
  "postCount": 0,
  "createdAt": "2024-01-01T00:00:00.000Z",
  "updatedAt": "2024-01-01T00:00:00.000Z"
}
```

**エラー時（400）:**
```json
{
  "error": "タイトル、説明、カテゴリーは必須です"
}
```

**エラー時（500）:**
```json
{
  "error": "スレッドの作成に失敗しました"
}
```

### 2.3 スレッド詳細取得

#### 基本情報
- **エンドポイント**: `GET /api/threads/{id}`
- **説明**: 指定されたスレッドの詳細情報を取得

#### リクエスト
```http
GET /api/threads/507f1f77bcf86cd799439011
```

#### レスポンス
**成功時（200）:**
```json
{
  "_id": "507f1f77bcf86cd799439011",
  "title": "スレッドタイトル",
  "description": "スレッドの説明",
  "category": "一般",
  "creator": "作成者名",
  "postCount": 5,
  "createdAt": "2024-01-01T00:00:00.000Z",
  "updatedAt": "2024-01-01T12:00:00.000Z"
}
```

**エラー時（404）:**
```json
{
  "error": "スレッドが見つかりません"
}
```

**エラー時（500）:**
```json
{
  "error": "スレッドの取得に失敗しました"
}
```

### 2.4 スレッド更新

#### 基本情報
- **エンドポイント**: `PUT /api/threads/{id}`
- **説明**: 指定されたスレッドの情報を更新

#### リクエスト
```http
PUT /api/threads/507f1f77bcf86cd799439011
Content-Type: application/json

{
  "title": "更新されたタイトル",
  "description": "更新された説明",
  "category": "テクノロジー",
  "creator": "更新者名"
}
```

#### バリデーション
- スレッド作成時と同じバリデーション

#### レスポンス
**成功時（200）:**
```json
{
  "_id": "507f1f77bcf86cd799439011",
  "title": "更新されたタイトル",
  "description": "更新された説明",
  "category": "テクノロジー",
  "creator": "更新者名",
  "postCount": 5,
  "createdAt": "2024-01-01T00:00:00.000Z",
  "updatedAt": "2024-01-01T13:00:00.000Z"
}
```

**エラー時（400）:**
```json
{
  "error": "タイトル、説明、カテゴリーは必須です"
}
```

**エラー時（404）:**
```json
{
  "error": "スレッドが見つかりません"
}
```

### 2.5 スレッド削除

#### 基本情報
- **エンドポイント**: `DELETE /api/threads/{id}`
- **説明**: 指定されたスレッドと関連する投稿を削除

#### リクエスト
```http
DELETE /api/threads/507f1f77bcf86cd799439011
```

#### レスポンス
**成功時（200）:**
```json
{
  "message": "スレッドを削除しました"
}
```

**エラー時（404）:**
```json
{
  "error": "スレッドが見つかりません"
}
```

**エラー時（500）:**
```json
{
  "error": "スレッドの削除に失敗しました"
}
```

## 3. 投稿関連API

### 3.1 投稿一覧取得（全体）

#### 基本情報
- **エンドポイント**: `GET /api/posts`
- **説明**: 全投稿を作成日時降順で取得

#### リクエスト
```http
GET /api/posts
```

#### レスポンス
**成功時（200）:**
```json
[
  {
    "_id": "507f1f77bcf86cd799439012",
    "title": "投稿タイトル",
    "content": "投稿内容",
    "threadId": "507f1f77bcf86cd799439011",
    "author": "投稿者名",
    "createdAt": "2024-01-01T01:00:00.000Z",
    "updatedAt": "2024-01-01T01:00:00.000Z"
  }
]
```

**エラー時（500）:**
```json
{
  "error": "Failed to fetch posts"
}
```

### 3.2 投稿作成（単体）

#### 基本情報
- **エンドポイント**: `POST /api/posts`
- **説明**: 新しい投稿を作成（単体投稿用）
- **注意**: 現在の実装ではthreadIdが設定されない

#### リクエスト
```http
POST /api/posts
Content-Type: application/json

{
  "title": "投稿タイトル",
  "content": "投稿内容"
}
```

#### バリデーション
- `title`: 必須、文字列
- `content`: 必須、文字列、最大200文字

#### レスポンス
**成功時（201）:**
```json
{
  "_id": "507f1f77bcf86cd799439012",
  "title": "投稿タイトル",
  "content": "投稿内容",
  "createdAt": "2024-01-01T01:00:00.000Z",
  "updatedAt": "2024-01-01T01:00:00.000Z"
}
```

**エラー時（400）:**
```json
{
  "error": "Title and content are required"
}
```

または

```json
{
  "error": "Content must be 200 characters or less"
}
```

### 3.3 スレッド内投稿一覧取得

#### 基本情報
- **エンドポイント**: `GET /api/threads/{id}/posts`
- **説明**: 指定されたスレッド内の投稿を作成日時昇順で取得

#### リクエスト
```http
GET /api/threads/507f1f77bcf86cd799439011/posts
```

#### レスポンス
**成功時（200）:**
```json
[
  {
    "_id": "507f1f77bcf86cd799439012",
    "title": "投稿タイトル",
    "content": "投稿内容",
    "threadId": "507f1f77bcf86cd799439011",
    "author": "投稿者名",
    "createdAt": "2024-01-01T01:00:00.000Z",
    "updatedAt": "2024-01-01T01:00:00.000Z"
  }
]
```

**エラー時（500）:**
```json
{
  "error": "投稿の取得に失敗しました"
}
```

### 3.4 スレッド内投稿作成

#### 基本情報
- **エンドポイント**: `POST /api/threads/{id}/posts`
- **説明**: 指定されたスレッドに新しい投稿を作成

#### リクエスト
```http
POST /api/threads/507f1f77bcf86cd799439011/posts
Content-Type: application/json

{
  "title": "投稿タイトル",
  "content": "投稿内容",
  "author": "投稿者名" // 省略可（デフォルト: "匿名"）
}
```

#### バリデーション
- `title`: 必須、文字列、最大100文字
- `content`: 必須、文字列、最大500文字
- `author`: 任意、文字列、最大50文字

#### レスポンス
**成功時（201）:**
```json
{
  "_id": "507f1f77bcf86cd799439012",
  "title": "投稿タイトル",
  "content": "投稿内容",
  "threadId": "507f1f77bcf86cd799439011",
  "author": "投稿者名",
  "createdAt": "2024-01-01T01:00:00.000Z",
  "updatedAt": "2024-01-01T01:00:00.000Z"
}
```

**エラー時（400）:**
```json
{
  "error": "タイトルと内容は必須です"
}
```

**副作用**: スレッドのpostCount +1、updatedAt更新

### 3.5 投稿詳細取得

#### 基本情報
- **エンドポイント**: `GET /api/posts/{id}`
- **説明**: 指定された投稿の詳細情報を取得

#### リクエスト
```http
GET /api/posts/507f1f77bcf86cd799439012
```

#### レスポンス
**成功時（200）:**
```json
{
  "_id": "507f1f77bcf86cd799439012",
  "title": "投稿タイトル",
  "content": "投稿内容",
  "threadId": "507f1f77bcf86cd799439011",
  "author": "投稿者名",
  "createdAt": "2024-01-01T01:00:00.000Z",
  "updatedAt": "2024-01-01T01:00:00.000Z"
}
```

**エラー時（400）:**
```json
{
  "error": "Invalid post ID"
}
```

**エラー時（404）:**
```json
{
  "error": "Post not found"
}
```

### 3.6 投稿更新

#### 基本情報
- **エンドポイント**: `PUT /api/posts/{id}`
- **説明**: 指定された投稿の情報を更新

#### リクエスト
```http
PUT /api/posts/507f1f77bcf86cd799439012
Content-Type: application/json

{
  "title": "更新された投稿タイトル",
  "content": "更新された投稿内容",
  "author": "更新者名"
}
```

#### バリデーション
- `title`: 必須、文字列、最大100文字
- `content`: 必須、文字列、最大500文字
- `author`: 任意、文字列、最大50文字

#### レスポンス
**成功時（200）:**
```json
{
  "_id": "507f1f77bcf86cd799439012",
  "title": "更新された投稿タイトル",
  "content": "更新された投稿内容",
  "threadId": "507f1f77bcf86cd799439011",
  "author": "更新者名",
  "createdAt": "2024-01-01T01:00:00.000Z",
  "updatedAt": "2024-01-01T02:00:00.000Z"
}
```

**エラー時（400）:**
```json
{
  "error": "無効な投稿IDです"
}
```

または

```json
{
  "error": "タイトルと内容は必須です"
}
```

または

```json
{
  "error": "内容は500文字以内で入力してください"
}
```

### 3.7 投稿削除

#### 基本情報
- **エンドポイント**: `DELETE /api/posts/{id}`
- **説明**: 指定された投稿を削除

#### リクエスト
```http
DELETE /api/posts/507f1f77bcf86cd799439012
```

#### レスポンス
**成功時（200）:**
```json
{
  "message": "投稿を削除しました"
}
```

**エラー時（400）:**
```json
{
  "error": "無効な投稿IDです"
}
```

**エラー時（404）:**
```json
{
  "error": "投稿が見つかりません"
}
```

**副作用**: 関連スレッドのpostCount -1、updatedAt更新

## 4. データベース接続

### 4.1 接続設定
- **ライブラリ**: Mongoose
- **設定ファイル**: `src/lib/dbConnect.ts`
- **接続方式**: Connection pooling with caching
- **環境変数**: `MONGODB_URI`

### 4.2 接続管理
- **グローバルキャッシュ**: development環境での接続再利用
- **エラーハンドリング**: 接続失敗時のエラー処理
- **オプション**: `bufferCommands: false`

## 5. エラーハンドリング

### 5.1 共通エラーパターン
- **バリデーションエラー**: 400番台、日本語エラーメッセージ
- **リソース不存在**: 404、統一されたエラーメッセージ
- **サーバーエラー**: 500、try-catchによる捕捉

### 5.2 ログ出力
- **コンソールログ**: console.error()によるエラー詳細出力
- **本番環境**: ログレベルの調整が必要

## 6. セキュリティ考慮事項

### 6.1 入力検証
- **文字数制限**: Mongooseスキーマレベルでの制限
- **必須項目チェック**: サーバーサイドでの検証
- **型チェック**: TypeScriptによる型安全性

### 6.2 データサニタイゼーション
- **トリム処理**: 前後の空白削除
- **HTMLエスケープ**: XSS対策（フロントエンド側）

### 6.3 認証・認可
- **現状**: 認証システムなし
- **将来**: JWT等の認証システム実装予定

## 7. パフォーマンス

### 7.1 データベースクエリ
- **インデックス**: `createdAt`、`updatedAt`フィールド
- **ソート**: データベースレベルでの並び順制御

### 7.2 レスポンス最適化
- **必要データのみ**: 過剰なデータ取得を避ける
- **エラーレスポンス**: 軽量なエラーメッセージ